# Work Packages: Slop Video Generator Web UI

*Path: [kitty-specs/001-slop-video-generator/tasks.md](kitty-specs/001-slop-video-generator/tasks.md)*

**Inputs**: Design documents from `/kitty-specs/001-slop-video-generator/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Not explicitly requested. Testing tasks omitted.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/kitty-specs/001-slop-video-generator/tasks/planned/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Project Setup & Scaffolding (Priority: P0)

**Goal**: Establish frontend and backend project structure with all tooling and dependencies configured.
**Independent Test**: `npm run dev` starts frontend on localhost:5173; `uvicorn src.main:app` starts backend on localhost:8000.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP01-project-setup.md`

### Included Subtasks
- [ ] T001 Initialize frontend with Vite + React + TypeScript in `frontend/`
- [ ] T002 [P] Configure Tailwind CSS in `frontend/tailwind.config.js`
- [ ] T003 [P] Configure ESLint and TypeScript strict mode in `frontend/`
- [ ] T004 [P] Initialize Python backend with FastAPI in `backend/`
- [ ] T005 [P] Create backend Dockerfile and requirements.txt
- [ ] T006 Create TypeScript type definitions in `frontend/src/types/index.ts`
- [ ] T007 [P] Create environment configuration files (.env.local, .env templates)

### Implementation Notes
- Frontend: `npm create vite@latest frontend -- --template react-ts`
- Backend: Basic FastAPI app with CORS middleware
- Install: react, vite, tailwindcss, postcss, autoprefixer (frontend); fastapi, uvicorn, python-multipart (backend)

### Parallel Opportunities
- T002, T003, T004, T005, T007 can proceed in parallel once T001 completes

### Dependencies
- None (starting package)

### Risks & Mitigations
- Node/Python version mismatch â†’ pin versions in .tool-versions or README

---

## Work Package WP02: React Context State Management (Priority: P0)

**Goal**: Implement all four React Context providers (Config, Scene, Asset, Workflow) with types and default values.
**Independent Test**: App renders without errors; contexts provide default values; useContext hooks work in components.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP02-state-management.md`

### Included Subtasks
- [ ] T008 Implement ConfigContext with API keys and settings state in `frontend/src/contexts/ConfigContext.tsx`
- [ ] T009 [P] Implement SceneContext with scenes array and streaming state in `frontend/src/contexts/SceneContext.tsx`
- [ ] T010 [P] Implement AssetContext with assets Map and timings in `frontend/src/contexts/AssetContext.tsx`
- [ ] T011 [P] Implement WorkflowContext with stage and progress state in `frontend/src/contexts/WorkflowContext.tsx`
- [ ] T012 Create context provider wrapper component in `frontend/src/App.tsx`

### Implementation Notes
- Follow data-model.md state shapes exactly (ConfigState, SceneState, AssetState, WorkflowState)
- Each context provides both state and dispatch/update functions
- WorkflowContext manages stage transitions: config â†’ scenes â†’ assets â†’ assembly â†’ output

### Parallel Opportunities
- T008, T009, T010, T011 can all proceed in parallel

### Dependencies
- Depends on WP01 (T006 type definitions)

### Risks & Mitigations
- Context re-render performance â†’ use useMemo for context values

---

## Work Package WP03: Configuration UI - User Story 2 & 3 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Build configuration screen with API key inputs, LLM provider/model selection, and video settings.
**Independent Test**: User can enter API keys, select LLM provider/model, configure video settings; values persist in ConfigContext.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP03-configuration-ui.md`

### Included Subtasks
- [ ] T013 Create ConfigScreen component shell in `frontend/src/components/config/ConfigScreen.tsx`
- [ ] T014 [P] Build ApiKeyInputs component with validation in `frontend/src/components/config/ApiKeyInputs.tsx`
- [ ] T015 [P] Build LlmProviderSelect component with model dropdown in `frontend/src/components/config/LlmProviderSelect.tsx`
- [ ] T016 [P] Build VideoSettings component (resolution, fps, scenes, duration) in `frontend/src/components/config/VideoSettings.tsx`
- [ ] T017 [P] Build TtsSettings component (voice, speed, model) in `frontend/src/components/config/TtsSettings.tsx`
- [ ] T018 Implement API key validation service in `frontend/src/services/validation.ts`
- [ ] T019 Add "Start Generation" button with stage transition

### Implementation Notes
- API key inputs: password type with show/hide toggle
- Provider selection filters model dropdown (OpenAI models vs DeepSeek models)
- Default values from FR-008 spec requirements
- Validate keys with lightweight API calls before allowing progression

### Parallel Opportunities
- T014, T015, T016, T017 can proceed in parallel once T013 shell exists

### Dependencies
- Depends on WP02 (ConfigContext)

### Risks & Mitigations
- Invalid API key UX â†’ show inline validation errors with retry option

---

## Work Package WP04: LLM Streaming Service & Scene Generation UI - User Story 1 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement streaming LLM client and scene generation interface with progressive display.
**Independent Test**: User enters prompt, clicks generate, sees scenes appear progressively as LLM streams; can edit scenes.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP04-scene-generation.md`

### Included Subtasks
- [ ] T020 Implement OpenAI streaming client in `frontend/src/services/llm.ts`
- [ ] T021 [P] Implement DeepSeek streaming client (OpenAI-compatible) in `frontend/src/services/llm.ts`
- [ ] T022 Create useStreaming hook for ReadableStream parsing in `frontend/src/hooks/useStreaming.ts`
- [ ] T023 Implement scene JSON parser with streaming buffer in `frontend/src/services/llm.ts`
- [ ] T024 Build SceneGenerationScreen component in `frontend/src/components/scenes/SceneGenerationScreen.tsx`
- [ ] T025 [P] Build PromptInput component in `frontend/src/components/scenes/PromptInput.tsx`
- [ ] T026 [P] Build SceneCard component (collapsible, editable) in `frontend/src/components/scenes/SceneCard.tsx`
- [ ] T027 Build SceneList with add/remove scene functionality in `frontend/src/components/scenes/SceneList.tsx`
- [ ] T028 Display token usage and estimated cost after generation
- [ ] T029 Add "Generate Assets" button with stage transition

### Implementation Notes
- LLM system prompt should request JSON array of {script, image_description} objects
- Target word count = targetDuration * 2.5 words (per FR-015)
- Parse streaming chunks: `data: {"choices":[{"delta":{"content":"..."}}]}\n\n`
- Handle `data: [DONE]` termination
- Scene cards expanded by default, user can collapse

### Parallel Opportunities
- T020/T021 (LLM clients) parallel with T024-T027 (UI components)
- T025, T026 can proceed in parallel

### Dependencies
- Depends on WP02 (SceneContext), WP03 (config settings)

### Risks & Mitigations
- Malformed JSON from LLM â†’ graceful parse error with retry option (FR-035)
- DeepSeek CORS issues â†’ fallback to OpenAI or show error

---

## Work Package WP05: Image Generation Service (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement OpenAI image generation with brightness correction and concurrency control.
**Independent Test**: Given scene image descriptions, images generate with max 12 concurrent requests; dark images auto-corrected.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP05-image-generation.md`

### Included Subtasks
- [ ] T030 Implement OpenAI image generation client in `frontend/src/services/images.ts`
- [ ] T031 [P] Implement brightness detection algorithm in `frontend/src/services/images.ts`
- [ ] T032 [P] Implement brightness correction using Canvas API in `frontend/src/services/images.ts`
- [ ] T033 Implement transparency flattening (to white background) in `frontend/src/services/images.ts`
- [ ] T034 Build concurrency limiter (max 12) in `frontend/src/services/images.ts`
- [ ] T035 Create image generation queue manager in `frontend/src/hooks/useAssetGeneration.ts`

### Implementation Notes
- Request `b64_json` response format to avoid CORS issues with URLs
- Brightness check: draw to canvas, compute average RGB, if < threshold apply correction
- Transparency: draw on white background canvas before export
- Queue: Array of pending scene IDs, pop up to 12 concurrent, track status in AssetContext

### Parallel Opportunities
- T031, T032 can proceed in parallel with T030

### Dependencies
- Depends on WP02 (AssetContext), WP04 (scenes data)

### Risks & Mitigations
- Rate limiting â†’ exponential backoff on 429 errors
- Memory usage â†’ release canvas resources after processing

---

## Work Package WP06: TTS Service with Context (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement ElevenLabs TTS with previous/next text context and concurrency control.
**Independent Test**: Given scene scripts, audio files generate with natural transitions; timing data captured; max 4 concurrent.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP06-tts-generation.md`

### Included Subtasks
- [ ] T036 Implement ElevenLabs TTS client in `frontend/src/services/tts.ts`
- [ ] T037 Implement previous_text/next_text context passing in `frontend/src/services/tts.ts`
- [ ] T038 [P] Parse timing/alignment data from TTS response in `frontend/src/services/tts.ts`
- [ ] T039 Build TTS concurrency limiter (max 4, configurable) in `frontend/src/services/tts.ts`
- [ ] T040 Integrate TTS generation into useAssetGeneration hook in `frontend/src/hooks/useAssetGeneration.ts`

### Implementation Notes
- Use `with_timestamps: true` for word-level timing data
- Context: previous scene's script as previous_text, next scene's as next_text (empty for first/last)
- Audio format: mp3_44100_128 for quality/size balance
- Store timing data in AssetContext.timings Map

### Parallel Opportunities
- T038 can proceed in parallel with T036, T037

### Dependencies
- Depends on WP02 (AssetContext), WP04 (scenes data)

### Risks & Mitigations
- TTS timeout â†’ retry with exponential backoff (FR-026)
- API quota exhausted â†’ clear error message (FR-035)

---

## Work Package WP07: Asset Generation UI - User Story 4 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Build asset generation screen with real-time progress and retry functionality.
**Independent Test**: Progress shown per scene (image + audio status); failed assets can be retried individually.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP07-asset-generation-ui.md`

### Included Subtasks
- [ ] T041 Build AssetGenerationScreen component in `frontend/src/components/assets/AssetGenerationScreen.tsx`
- [ ] T042 [P] Build AssetProgressCard component (pending/generating/complete/failed) in `frontend/src/components/assets/AssetProgressCard.tsx`
- [ ] T043 [P] Build RetryButton component for failed assets in `frontend/src/components/assets/RetryButton.tsx`
- [ ] T044 Display overall progress bar/indicator in `frontend/src/components/assets/AssetGenerationScreen.tsx`
- [ ] T045 Implement asset generation orchestration (start all, track status) in `frontend/src/hooks/useAssetGeneration.ts`
- [ ] T046 Add "Assemble Video" button enabled when all assets complete

### Implementation Notes
- Card shows scene number, image thumbnail (when ready), audio waveform/icon, status badge
- Failed state shows error message and retry button
- Overall progress: X of Y scenes complete (images + audio)
- Retry: re-trigger single asset generation without affecting others (FR-026)

### Parallel Opportunities
- T042, T043 can proceed in parallel

### Dependencies
- Depends on WP05 (images), WP06 (TTS), WP02 (AssetContext)

### Risks & Mitigations
- Partial failures â†’ ensure completed assets preserved, only failed ones retry

---

## Work Package WP08: Backend Video Assembly (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement FastAPI endpoint and FFmpeg service for video assembly.
**Independent Test**: POST /assemble-video with images + audio returns valid MP4 video file.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP08-video-assembly-backend.md`

### Included Subtasks
- [ ] T047 Implement /health endpoint in `backend/src/routes/health.py`
- [ ] T048 Create Pydantic models for AssemblyMetadata in `backend/src/models/requests.py`
- [ ] T049 Implement /assemble-video endpoint (multipart handling) in `backend/src/routes/assemble.py`
- [ ] T050 [P] Implement FFmpeg image-to-video conversion in `backend/src/services/ffmpeg.py`
- [ ] T051 [P] Implement FFmpeg audio concatenation in `backend/src/services/ffmpeg.py`
- [ ] T052 Implement FFmpeg video+audio merge in `backend/src/services/ffmpeg.py`
- [ ] T053 Add error handling and logging in `backend/src/routes/assemble.py`
- [ ] T054 Configure CORS middleware in `backend/src/main.py`

### Implementation Notes
- Follow contracts/video-assembly.yaml OpenAPI spec exactly
- FFmpeg commands per research.md:
  - Image sequence: `ffmpeg -loop 1 -t {duration} -i image.png -vf scale=W:H -r FPS`
  - Audio concat: `ffmpeg -i "concat:a1.mp3|a2.mp3" -c copy`
  - Merge: `ffmpeg -i video.mp4 -i audio.mp3 -c:v copy -c:a aac output.mp4`
- Use /tmp for temp files (Cloud Run tmpfs)
- Return video with Content-Disposition header for download

### Parallel Opportunities
- T050, T051 (FFmpeg utilities) can proceed in parallel

### Dependencies
- Depends on WP01 (backend setup)

### Risks & Mitigations
- FFmpeg not found â†’ ensure in Dockerfile, provide clear error
- Timeout on long videos â†’ set 300s timeout in Cloud Run config

---

## Work Package WP09: Video Assembly Client & Output UI - User Story 6 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Frontend client for video assembly API and output screen with playback and download.
**Independent Test**: User clicks "Assemble Video", sees progress, video plays in browser, download works.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP09-video-output.md`

### Included Subtasks
- [ ] T055 Implement video assembly client in `frontend/src/services/video.ts`
- [ ] T056 Build VideoAssemblyScreen component in `frontend/src/components/video/VideoAssemblyScreen.tsx`
- [ ] T057 [P] Build VideoPlayer component with standard controls in `frontend/src/components/video/VideoPlayer.tsx`
- [ ] T058 [P] Build DownloadButton component with filename generation in `frontend/src/components/video/DownloadButton.tsx`
- [ ] T059 Display assembly progress indicator during processing
- [ ] T060 Store final video in WorkflowContext and update stage to 'output'

### Implementation Notes
- Client: multipart/form-data POST with images as files, audio as files, metadata JSON
- Progress: show spinner/progress bar during backend processing
- Player: HTML5 video element with controls attribute
- Download: create blob URL, trigger download with generated filename (slop-video-YYYY-MM-DD.mp4)

### Parallel Opportunities
- T057, T058 can proceed in parallel

### Dependencies
- Depends on WP08 (backend endpoint), WP07 (all assets ready)

### Risks & Mitigations
- Large video transfer â†’ stream response, show progress
- Backend unavailable â†’ clear error message with retry option (FR-035)

---

## Work Package WP10: Error Handling & Polish - User Story 5 (Priority: P2)

**Goal**: Comprehensive error handling, navigation warnings, and UX polish across all stages.
**Independent Test**: All error scenarios show user-friendly messages; navigation warning appears during generation.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP10-error-handling-polish.md`

### Included Subtasks
- [ ] T061 Create ErrorBoundary component in `frontend/src/components/ui/ErrorBoundary.tsx`
- [ ] T062 [P] Create Toast/Notification component for transient errors in `frontend/src/components/ui/Toast.tsx`
- [ ] T063 Implement beforeunload warning during active generation
- [ ] T064 [P] Add inline error states to all form inputs
- [ ] T065 [P] Add loading states to all buttons
- [ ] T066 Add keyboard navigation and accessibility attributes
- [ ] T067 Implement backend error logging to Google Cloud Logging in `backend/src/main.py`
- [ ] T068 Final UI polish: responsive layout, consistent spacing

### Implementation Notes
- Error boundary: catch React errors, show fallback with "Try Again" button
- Toast: auto-dismiss after 5s, error/warning/success variants
- beforeunload: `window.addEventListener('beforeunload', handler)` when isGenerating
- Accessibility: ARIA labels, focus management, keyboard shortcuts

### Parallel Opportunities
- T062, T064, T065 can proceed in parallel

### Dependencies
- Depends on completion of WP03-WP09 (all core features)

### Risks & Mitigations
- Regression risk â†’ manual smoke test through full workflow

---

## Work Package WP11: CI/CD Deployment Workflows (Priority: P2)

**Goal**: Create GitHub Actions workflows for automated deployment to GitHub Pages (frontend) and Cloud Run (backend).
**Independent Test**: Push to main branch triggers deployments; frontend accessible at GitHub Pages URL; backend accessible at Cloud Run URL.
**Prompt**: `/kitty-specs/001-slop-video-generator/tasks/planned/WP11-deployment-workflows.md`

### Included Subtasks
- [ ] T069 Create GitHub Actions workflow for frontend deployment in `.github/workflows/deploy-frontend.yml`
- [ ] T070 [P] Create GitHub Actions workflow for backend deployment in `.github/workflows/deploy-backend.yml`
- [ ] T071 Configure GitHub Pages settings for frontend static hosting
- [ ] T072 [P] Create Cloud Build configuration in `backend/cloudbuild.yaml`
- [ ] T073 Update frontend environment variables for production backend URL
- [ ] T074 Document deployment process in README.md

### Implementation Notes
- Frontend workflow: build with `npm run build`, deploy to GitHub Pages
- Backend workflow: build Docker image, push to GCR, deploy to Cloud Run
- Use GitHub secrets for GCP credentials and project ID
- Frontend needs `VITE_BACKEND_URL` set to Cloud Run URL for production build
- Cloud Run config: 2GB memory, 300s timeout, allow unauthenticated

### Parallel Opportunities
- T069/T071 (frontend) and T070/T072 (backend) can proceed in parallel

### Dependencies
- Depends on WP01 (project structure), WP08 (backend Dockerfile)

### Risks & Mitigations
- GCP credentials exposure â†’ use GitHub encrypted secrets
- CORS issues in production â†’ verify Cloud Run URL in frontend CORS config

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02 â†’ WP03/WP04 (can parallel) â†’ WP05/WP06 (can parallel) â†’ WP07 â†’ WP08 (can start with WP04) â†’ WP09 â†’ WP10 â†’ WP11
- **Parallelization**:
  - WP03 (Config UI) and WP04 (Scene Generation) can proceed in parallel after WP02
  - WP05 (Images) and WP06 (TTS) can proceed in parallel after WP04
  - WP08 (Backend) can start after WP01, parallel to frontend work
  - WP11 (Deployment) can start after WP08, parallel to WP10
- **MVP Scope**: WP01 through WP09 constitute the minimal viable release. WP10 and WP11 are enhancement/deployment.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Initialize Vite React frontend | WP01 | P0 | No |
| T002 | Configure Tailwind CSS | WP01 | P0 | Yes |
| T003 | Configure ESLint/TypeScript | WP01 | P0 | Yes |
| T004 | Initialize FastAPI backend | WP01 | P0 | Yes |
| T005 | Create Dockerfile/requirements | WP01 | P0 | Yes |
| T006 | TypeScript type definitions | WP01 | P0 | No |
| T007 | Environment config files | WP01 | P0 | Yes |
| T008 | ConfigContext implementation | WP02 | P0 | No |
| T009 | SceneContext implementation | WP02 | P0 | Yes |
| T010 | AssetContext implementation | WP02 | P0 | Yes |
| T011 | WorkflowContext implementation | WP02 | P0 | Yes |
| T012 | Context provider wrapper | WP02 | P0 | No |
| T013 | ConfigScreen component shell | WP03 | P1 | No |
| T014 | ApiKeyInputs component | WP03 | P1 | Yes |
| T015 | LlmProviderSelect component | WP03 | P1 | Yes |
| T016 | VideoSettings component | WP03 | P1 | Yes |
| T017 | TtsSettings component | WP03 | P1 | Yes |
| T018 | API key validation service | WP03 | P1 | No |
| T019 | Start Generation button | WP03 | P1 | No |
| T020 | OpenAI streaming client | WP04 | P1 | No |
| T021 | DeepSeek streaming client | WP04 | P1 | Yes |
| T022 | useStreaming hook | WP04 | P1 | No |
| T023 | Scene JSON parser | WP04 | P1 | No |
| T024 | SceneGenerationScreen component | WP04 | P1 | No |
| T025 | PromptInput component | WP04 | P1 | Yes |
| T026 | SceneCard component | WP04 | P1 | Yes |
| T027 | SceneList component | WP04 | P1 | No |
| T028 | Token usage display | WP04 | P1 | No |
| T029 | Generate Assets button | WP04 | P1 | No |
| T030 | OpenAI image generation client | WP05 | P1 | No |
| T031 | Brightness detection | WP05 | P1 | Yes |
| T032 | Brightness correction | WP05 | P1 | Yes |
| T033 | Transparency flattening | WP05 | P1 | No |
| T034 | Image concurrency limiter | WP05 | P1 | No |
| T035 | Image generation queue | WP05 | P1 | No |
| T036 | ElevenLabs TTS client | WP06 | P1 | No |
| T037 | TTS context passing | WP06 | P1 | No |
| T038 | TTS timing parser | WP06 | P1 | Yes |
| T039 | TTS concurrency limiter | WP06 | P1 | No |
| T040 | TTS integration hook | WP06 | P1 | No |
| T041 | AssetGenerationScreen component | WP07 | P1 | No |
| T042 | AssetProgressCard component | WP07 | P1 | Yes |
| T043 | RetryButton component | WP07 | P1 | Yes |
| T044 | Overall progress indicator | WP07 | P1 | No |
| T045 | Asset orchestration | WP07 | P1 | No |
| T046 | Assemble Video button | WP07 | P1 | No |
| T047 | /health endpoint | WP08 | P1 | No |
| T048 | Pydantic models | WP08 | P1 | No |
| T049 | /assemble-video endpoint | WP08 | P1 | No |
| T050 | FFmpeg image-to-video | WP08 | P1 | Yes |
| T051 | FFmpeg audio concat | WP08 | P1 | Yes |
| T052 | FFmpeg video+audio merge | WP08 | P1 | No |
| T053 | Backend error handling | WP08 | P1 | No |
| T054 | CORS middleware | WP08 | P1 | No |
| T055 | Video assembly client | WP09 | P1 | No |
| T056 | VideoAssemblyScreen component | WP09 | P1 | No |
| T057 | VideoPlayer component | WP09 | P1 | Yes |
| T058 | DownloadButton component | WP09 | P1 | Yes |
| T059 | Assembly progress indicator | WP09 | P1 | No |
| T060 | Final video state update | WP09 | P1 | No |
| T061 | ErrorBoundary component | WP10 | P2 | No |
| T062 | Toast component | WP10 | P2 | Yes |
| T063 | Navigation warning | WP10 | P2 | No |
| T064 | Inline error states | WP10 | P2 | Yes |
| T065 | Loading states | WP10 | P2 | Yes |
| T066 | Accessibility | WP10 | P2 | No |
| T067 | Cloud Logging | WP10 | P2 | No |
| T068 | Final UI polish | WP10 | P2 | No |
| T069 | Frontend deployment workflow | WP11 | P2 | No |
| T070 | Backend deployment workflow | WP11 | P2 | Yes |
| T071 | GitHub Pages configuration | WP11 | P2 | No |
| T072 | Cloud Build configuration | WP11 | P2 | Yes |
| T073 | Production env variables | WP11 | P2 | No |
| T074 | Deployment documentation | WP11 | P2 | No |
